import io
import os
from pathlib import Path

import numpy as np
import pytest
import soundfile as sf
import yaml
from osekit.utils.timestamp_utils import strftime_osmose_format
from pandas import DataFrame, read_csv
from pandas.tseries import frequencies

SAMPLE = """dataset,filename,start_time,end_time,start_frequency,end_frequency,annotation,annotator,start_datetime,end_datetime,type,score
sample_dataset,2025_01_25_06_20_00,0.0,10.0,0.0,72000.0,lbl2,ann2,2025-01-25T06:20:00.000+00:00,2025-01-25T06:20:10.000+00:00,WEAK,0.11
sample_dataset,2025_01_25_06_20_00,3.46662989520132,4.02371759514617,7523.0,15257.0,lbl2,ann2,2025-01-25T06:20:03.466+00:00,2025-01-25T06:20:04.023+00:00,BOX,0.23
sample_dataset,2025_01_25_06_20_00,0.0,10.0,0.0,72000.0,lbl1,ann2,2025-01-25T06:20:00.000+00:00,2025-01-25T06:20:10.000+00:00,WEAK,0.26
sample_dataset,2025_01_25_06_20_00,0.0,10.0,0.0,72000.0,lbl1,ann5,2025-01-25T06:20:00.000+00:00,2025-01-25T06:20:10.000+00:00,WEAK,0.35
sample_dataset,2025_01_25_06_20_00,0.0717043574186431,8.90788747931605,1265.0,10265.0,lbl1,ann5,2025-01-25T06:20:00.071+00:00,2025-01-25T06:20:08.907+00:00,BOX,0.36
sample_dataset,2025_01_25_06_20_00,0.0,10.0,0.0,72000.0,lbl2,ann1,2025-01-25T06:20:00.000+00:00,2025-01-25T06:20:10.000+00:00,WEAK,0.72
sample_dataset,2025_01_25_06_20_00,3.32873690016547,4.0457804743519,7031.0,16453.0,lbl2,ann1,2025-01-25T06:20:03.328+00:00,2025-01-25T06:20:04.045+00:00,BOX,0.31
sample_dataset,2025_01_25_06_20_00,7.03530060672918,7.64754550468836,6468.0,15187.0,lbl2,ann1,2025-01-25T06:20:07.035+00:00,2025-01-25T06:20:07.647+00:00,BOX,0.86
sample_dataset,2025_01_25_06_20_00,0.0,10.0,0.0,72000.0,lbl1,ann1,2025-01-25T06:20:00.000+00:00,2025-01-25T06:20:10.000+00:00,WEAK,0.37
sample_dataset,2025_01_25_06_20_00,0.0,10.0,0.0,72000.0,lbl2,ann4,2025-01-25T06:20:00.000+00:00,2025-01-25T06:20:10.000+00:00,WEAK,0.11
sample_dataset,2025_01_25_06_20_00,3.30667402095974,4.00165471594043,7875.0,19828.0,lbl2,ann4,2025-01-25T06:20:03.306+00:00,2025-01-25T06:20:04.001+00:00,BOX,0.81
sample_dataset,2025_01_25_06_20_00,0.0,10.0,0.0,72000.0,lbl2,ann3,2025-01-25T06:20:00.000+00:00,2025-01-25T06:20:10.000+00:00,WEAK,0.58
sample_dataset,2025_01_25_06_20_00,3.24014216505327,3.86811049852255,8198.0,16697.0,lbl2,ann3,2025-01-25T06:20:03.240+00:00,2025-01-25T06:20:03.868+00:00,BOX,0.66
sample_dataset,2025_01_25_06_20_00,6.77537130162104,7.62041510838834,6816.0,17292.0,lbl2,ann3,2025-01-25T06:20:06.775+00:00,2025-01-25T06:20:07.620+00:00,BOX,0.90
sample_dataset,2025_01_25_06_20_10,0.0,10.0,0.0,72000.0,lbl2,ann2,2025-01-25T06:20:10.000+00:00,2025-01-25T06:20:20.000+00:00,WEAK,0.24
sample_dataset,2025_01_25_06_20_10,0.355763927192499,0.603971318257033,7804.0,11953.0,lbl2,ann2,2025-01-25T06:20:10.355+00:00,2025-01-25T06:20:10.603+00:00,BOX,0.76
sample_dataset,2025_01_25_06_20_10,0.0,10.0,0.0,72000.0,lbl1,ann2,2025-01-25T06:20:10.000+00:00,2025-01-25T06:20:20.000+00:00,WEAK,0.54
sample_dataset,2025_01_25_06_20_10,0.0,10.0,0.0,72000.0,lbl2,ann5,2025-01-25T06:20:10.000+00:00,2025-01-25T06:20:20.000+00:00,WEAK,0.85
sample_dataset,2025_01_25_06_20_10,0.325427468284611,0.672917815774959,6890.0,11390.0,lbl2,ann5,2025-01-25T06:20:10.325+00:00,2025-01-25T06:20:10.672+00:00,BOX,0.53
sample_dataset,2025_01_25_06_20_10,0.0,10.0,0.0,72000.0,lbl3,ann5,2025-01-25T06:20:10.000+00:00,2025-01-25T06:20:20.000+00:00,WEAK,0.30
sample_dataset,2025_01_25_06_20_10,1.14726971869829,1.4726971869829,4640.0,13781.0,lbl3,ann5,2025-01-25T06:20:11.147+00:00,2025-01-25T06:20:11.472+00:00,BOX,0.16
sample_dataset,2025_01_25_06_20_10,0.0,10.0,0.0,72000.0,lbl1,ann5,2025-01-25T06:20:10.000+00:00,2025-01-25T06:20:20.000+00:00,WEAK,0.97
sample_dataset,2025_01_25_06_20_10,0.066188637617209,8.90788747931605,843.0,14203.0,lbl1,ann5,2025-01-25T06:20:10.066+00:00,2025-01-25T06:20:18.907+00:00,BOX,0.59
sample_dataset,2025_01_25_06_20_10,0.0,10.0,0.0,72000.0,lbl2,ann1,2025-01-25T06:20:10.000+00:00,2025-01-25T06:20:20.000+00:00,WEAK,0.46
sample_dataset,2025_01_25_06_20_10,0.151682294539437,0.659128516271373,4781.0,13359.0,lbl2,ann1,2025-01-25T06:20:10.151+00:00,2025-01-25T06:20:10.659+00:00,BOX,0.50
sample_dataset,2025_01_25_06_20_10,0.0,10.0,0.0,72000.0,lbl1,ann1,2025-01-25T06:20:10.000+00:00,2025-01-25T06:20:20.000+00:00,WEAK,0.10
sample_dataset,2025_01_25_06_20_20,0.0,10.0,0.0,72000.0,lbl1,ann2,2025-01-25T06:20:20.000+00:00,2025-01-25T06:20:30.000+00:00,WEAK,0.41
sample_dataset,2025_01_25_06_20_20,0.0,10.0,0.0,72000.0,lbl2,ann2,2025-01-25T06:20:20.000+00:00,2025-01-25T06:20:30.000+00:00,WEAK,0.36
sample_dataset,2025_01_25_06_20_20,1.56370656370656,2.44622173193602,8296.0,14132.0,lbl2,ann2,2025-01-25T06:20:21.563+00:00,2025-01-25T06:20:22.446+00:00,BOX,0.45
sample_dataset,2025_01_25_06_20_20,0.0,10.0,0.0,72000.0,lbl1,ann5,2025-01-25T06:20:20.000+00:00,2025-01-25T06:20:30.000+00:00,WEAK,0.62
sample_dataset,2025_01_25_06_20_20,0.0992829564258136,8.88582460011031,562.0,11531.0,lbl1,ann5,2025-01-25T06:20:20.099+00:00,2025-01-25T06:20:28.885+00:00,BOX,0.64
sample_dataset,2025_01_25_06_20_20,0.0,10.0,0.0,72000.0,lbl2,ann5,2025-01-25T06:20:20.000+00:00,2025-01-25T06:20:30.000+00:00,WEAK,0.80
sample_dataset,2025_01_25_06_20_20,1.62713734142306,2.32763375620518,7875.0,13500.0,lbl2,ann5,2025-01-25T06:20:21.627+00:00,2025-01-25T06:20:22.327+00:00,BOX,0.56
sample_dataset,2025_01_25_06_20_20,0.0,10.0,0.0,72000.0,lbl2,ann1,2025-01-25T06:20:20.000+00:00,2025-01-25T06:20:30.000+00:00,WEAK,0.94
sample_dataset,2025_01_25_06_20_20,1.54164368450083,2.44070601213458,5484.0,17859.0,lbl2,ann1,2025-01-25T06:20:21.541+00:00,2025-01-25T06:20:22.440+00:00,BOX,0.68
sample_dataset,2025_01_25_06_20_20,0.0,10.0,0.0,72000.0,lbl1,ann1,2025-01-25T06:20:20.000+00:00,2025-01-25T06:20:30.000+00:00,WEAK,0.15
sample_dataset,2025_01_25_06_20_20,0.0,10.0,0.0,72000.0,lbl2,ann3,2025-01-25T06:20:20.000+00:00,2025-01-25T06:20:30.000+00:00,WEAK,0.56
sample_dataset,2025_01_25_06_20_20,2.0111693378581,2.41105902346208,8577.0,15082.0,lbl2,ann3,2025-01-25T06:20:22.011+00:00,2025-01-25T06:20:22.411+00:00,BOX,0.46
sample_dataset,2025_01_25_06_20_20,6.0238554934014,6.52716492528226,8049.0,12620.0,lbl2,ann3,2025-01-25T06:20:26.023+00:00,2025-01-25T06:20:26.527+00:00,BOX,0.43
sample_dataset,2025_01_25_06_20_30,0.0,10.0,0.0,72000.0,lbl1,ann2,2025-01-25T06:20:30.000+00:00,2025-01-25T06:20:40.000+00:00,WEAK,0.94
sample_dataset,2025_01_25_06_20_30,0.0,10.0,0.0,72000.0,lbl2,ann2,2025-01-25T06:20:30.000+00:00,2025-01-25T06:20:40.000+00:00,WEAK,0.78
sample_dataset,2025_01_25_06_20_30,2.10700496414782,3.14396028681743,9843.0,15539.0,lbl2,ann2,2025-01-25T06:20:32.107+00:00,2025-01-25T06:20:33.143+00:00,BOX,0.40
sample_dataset,2025_01_25_06_20_30,4.06784335355764,5.36679536679537,8015.0,20742.0,lbl2,ann2,2025-01-25T06:20:34.067+00:00,2025-01-25T06:20:35.366+00:00,BOX,0.15
sample_dataset,2025_01_25_06_20_30,0.0,10.0,0.0,72000.0,lbl1,ann5,2025-01-25T06:20:30.000+00:00,2025-01-25T06:20:40.000+00:00,WEAK,0.61
sample_dataset,2025_01_25_06_20_30,0.0275785990071704,8.94098179812466,562.0,13640.0,lbl1,ann5,2025-01-25T06:20:30.027+00:00,2025-01-25T06:20:38.940+00:00,BOX,0.14
sample_dataset,2025_01_25_06_20_30,0.0,10.0,0.0,72000.0,lbl2,ann5,2025-01-25T06:20:30.000+00:00,2025-01-25T06:20:40.000+00:00,WEAK,0.78
sample_dataset,2025_01_25_06_20_30,4.19194704908991,5.31715388858246,6328.0,19687.0,lbl2,ann5,2025-01-25T06:20:34.191+00:00,2025-01-25T06:20:35.317+00:00,BOX,0.20
sample_dataset,2025_01_25_06_20_30,2.26696083838941,2.79095421952565,9281.0,16453.0,lbl2,ann5,2025-01-25T06:20:32.266+00:00,2025-01-25T06:20:32.790+00:00,BOX,0.30
sample_dataset,2025_01_25_06_20_30,0.0,10.0,0.0,72000.0,lbl2,ann1,2025-01-25T06:20:30.000+00:00,2025-01-25T06:20:40.000+00:00,WEAK,0.56
sample_dataset,2025_01_25_06_20_30,2.1042471042471,3.00330943188086,8296.0,18562.0,lbl2,ann1,2025-01-25T06:20:32.104+00:00,2025-01-25T06:20:33.003+00:00,BOX,0.13
sample_dataset,2025_01_25_06_20_30,4.04026475455047,5.41919470490899,7312.0,21515.0,lbl2,ann1,2025-01-25T06:20:34.040+00:00,2025-01-25T06:20:35.419+00:00,BOX,0.92
sample_dataset,2025_01_25_06_20_30,0.0,10.0,0.0,72000.0,lbl2,ann1,2025-01-25T06:20:30.000+00:00,2025-01-25T06:20:40.000+00:00,WEAK,0.76
sample_dataset,2025_01_25_06_20_30,0.0,10.0,0.0,72000.0,lbl2,ann1,2025-01-25T06:20:30.000+00:00,2025-01-25T06:20:40.000+00:00,WEAK,0.31
sample_dataset,2025_01_25_06_20_30,0.0,10.0,0.0,72000.0,lbl1,ann1,2025-01-25T06:20:30.000+00:00,2025-01-25T06:20:40.000+00:00,WEAK,0.41
sample_dataset,2025_01_25_06_20_30,0.0,10.0,0.0,72000.0,lbl2,ann6,2025-01-25T06:20:30.000+00:00,2025-01-25T06:20:40.000+00:00,WEAK,0.15
sample_dataset,2025_01_25_06_20_30,1.97186982901269,2.93160507446222,8578.0,17578.0,lbl2,ann6,2025-01-25T06:20:31.971+00:00,2025-01-25T06:20:32.931+00:00,BOX,0.49
sample_dataset,2025_01_25_06_20_30,3.78102592388307,5.57363485934914,8437.0,22078.0,lbl2,ann6,2025-01-25T06:20:33.781+00:00,2025-01-25T06:20:35.573+00:00,BOX,0.28
sample_dataset,2025_01_25_06_20_30,0.0,10.0,0.0,72000.0,lbl2,ann4,2025-01-25T06:20:30.000+00:00,2025-01-25T06:20:40.000+00:00,WEAK,0.58
sample_dataset,2025_01_25_06_20_30,2.11527854384997,3.12465526751241,6890.0,18843.0,lbl2,ann4,2025-01-25T06:20:32.115+00:00,2025-01-25T06:20:33.124+00:00,BOX,0.99
sample_dataset,2025_01_25_06_20_30,4.10645339216768,5.41367898510756,7453.0,19125.0,lbl2,ann4,2025-01-25T06:20:34.106+00:00,2025-01-25T06:20:35.413+00:00,BOX,0.22
sample_dataset,2025_01_25_06_20_30,0.0,10.0,0.0,72000.0,lbl2,ann3,2025-01-25T06:20:30.000+00:00,2025-01-25T06:20:40.000+00:00,WEAK,0.62
sample_dataset,2025_01_25_06_20_30,4.24503585743891,5.25854937095242,9807.0,18245.0,lbl2,ann3,2025-01-25T06:20:34.245+00:00,2025-01-25T06:20:35.258+00:00,BOX,0.65
sample_dataset,2025_01_25_06_20_40,0.0,10.0,0.0,72000.0,lbl2,ann2,2025-01-25T06:20:40.000+00:00,2025-01-25T06:20:50.000+00:00,WEAK,0.26
sample_dataset,2025_01_25_06_20_40,4.02371759514617,4.86210700496415,8015.0,17085.0,lbl2,ann2,2025-01-25T06:20:44.023+00:00,2025-01-25T06:20:44.862+00:00,BOX,0.75
sample_dataset,2025_01_25_06_20_40,0.0,10.0,0.0,72000.0,lbl1,ann2,2025-01-25T06:20:40.000+00:00,2025-01-25T06:20:50.000+00:00,WEAK,0.21
sample_dataset,2025_01_25_06_20_40,0.0,10.0,0.0,72000.0,lbl1,ann5,2025-01-25T06:20:40.000+00:00,2025-01-25T06:20:50.000+00:00,WEAK,0.11
sample_dataset,2025_01_25_06_20_40,0.137892995035852,8.92443463872035,562.0,14203.0,lbl1,ann5,2025-01-25T06:20:40.137+00:00,2025-01-25T06:20:48.924+00:00,BOX,0.50
sample_dataset,2025_01_25_06_20_40,0.0,10.0,0.0,72000.0,lbl2,ann5,2025-01-25T06:20:40.000+00:00,2025-01-25T06:20:50.000+00:00,WEAK,0.33
sample_dataset,2025_01_25_06_20_40,4.09817981246553,4.78764478764479,6609.0,15468.0,lbl2,ann5,2025-01-25T06:20:44.098+00:00,2025-01-25T06:20:44.787+00:00,BOX,0.42
sample_dataset,2025_01_25_06_20_40,0.0,10.0,0.0,72000.0,lbl2,ann1,2025-01-25T06:20:40.000+00:00,2025-01-25T06:20:50.000+00:00,WEAK,0.31
sample_dataset,2025_01_25_06_20_40,4.0292333149476,4.86210700496415,8296.0,15046.0,lbl2,ann1,2025-01-25T06:20:44.029+00:00,2025-01-25T06:20:44.862+00:00,BOX,0.79
sample_dataset,2025_01_25_06_20_40,0.0,10.0,0.0,72000.0,lbl1,ann1,2025-01-25T06:20:40.000+00:00,2025-01-25T06:20:50.000+00:00,WEAK,0.66
sample_dataset,2025_01_25_06_20_40,0.0,10.0,0.0,72000.0,lbl2,ann6,2025-01-25T06:20:40.000+00:00,2025-01-25T06:20:50.000+00:00,WEAK,0.66
sample_dataset,2025_01_25_06_20_40,4.03474903474903,4.97793712079426,9843.0,18984.0,lbl2,ann6,2025-01-25T06:20:44.034+00:00,2025-01-25T06:20:44.977+00:00,BOX,0.76
sample_dataset,2025_01_25_06_20_40,0.0,10.0,0.0,72000.0,lbl2,ann4,2025-01-25T06:20:40.000+00:00,2025-01-25T06:20:50.000+00:00,WEAK,0.27
sample_dataset,2025_01_25_06_20_40,3.95201323772752,4.88968560397132,7593.0,17718.0,lbl2,ann4,2025-01-25T06:20:43.952+00:00,2025-01-25T06:20:44.889+00:00,BOX,0.42
sample_dataset,2025_01_25_06_20_40,0.0,10.0,0.0,72000.0,lbl1,ann6,2025-01-25T06:20:40.000+00:00,2025-01-25T06:20:50.000+00:00,WEAK,0.56
sample_dataset,2025_01_25_06_20_40,0.0,10.0,0.0,72000.0,lbl2,ann3,2025-01-25T06:20:40.000+00:00,2025-01-25T06:20:50.000+00:00,WEAK,0.62
sample_dataset,2025_01_25_06_20_40,3.96924986736721,5.04481522864685,7451.0,17118.0,lbl2,ann3,2025-01-25T06:20:43.969+00:00,2025-01-25T06:20:45.044+00:00,BOX,0.78
sample_dataset,2025_01_25_06_20_50,0.0,10.0,0.0,72000.0,lbl1,ann2,2025-01-25T06:20:50.000+00:00,2025-01-25T06:21:00.000+00:00,WEAK,0.39
sample_dataset,2025_01_25_06_20_50,0.0,10.0,0.0,72000.0,lbl2,ann2,2025-01-25T06:20:50.000+00:00,2025-01-25T06:21:00.000+00:00,WEAK,0.50
sample_dataset,2025_01_25_06_20_50,4.28571428571429,4.82625482625483,6820.0,15187.0,lbl2,ann2,2025-01-25T06:20:54.285+00:00,2025-01-25T06:20:54.826+00:00,BOX,0.93
sample_dataset,2025_01_25_06_20_50,0.0,10.0,0.0,72000.0,lbl2,ann5,2025-01-25T06:20:50.000+00:00,2025-01-25T06:21:00.000+00:00,WEAK,0.19
sample_dataset,2025_01_25_06_20_50,4.3849972421401,4.65526751241037,8718.0,12937.0,lbl2,ann5,2025-01-25T06:20:54.384+00:00,2025-01-25T06:20:54.655+00:00,BOX,0.16
sample_dataset,2025_01_25_06_20_50,0.0,10.0,0.0,72000.0,lbl1,ann5,2025-01-25T06:20:50.000+00:00,2025-01-25T06:21:00.000+00:00,WEAK,0.81
sample_dataset,2025_01_25_06_20_50,0.126861555432984,8.92443463872035,281.0,11531.0,lbl1,ann5,2025-01-25T06:20:50.126+00:00,2025-01-25T06:20:58.924+00:00,BOX,0.41
sample_dataset,2025_01_25_06_20_50,0.0,10.0,0.0,72000.0,lbl2,ann1,2025-01-25T06:20:50.000+00:00,2025-01-25T06:21:00.000+00:00,WEAK,0.19
sample_dataset,2025_01_25_06_20_50,4.288472145615,4.7738554881412,7453.0,14343.0,lbl2,ann1,2025-01-25T06:20:54.288+00:00,2025-01-25T06:20:54.773+00:00,BOX,0.32
sample_dataset,2025_01_25_06_20_50,0.0,10.0,0.0,72000.0,lbl1,ann1,2025-01-25T06:20:50.000+00:00,2025-01-25T06:21:00.000+00:00,WEAK,0.26
sample_dataset,2025_01_25_06_20_50,0.0,10.0,0.0,72000.0,lbl2,ann6,2025-01-25T06:20:50.000+00:00,2025-01-25T06:21:00.000+00:00,WEAK,0.48
sample_dataset,2025_01_25_06_20_50,4.10645339216768,4.85107556536128,6750.0,17296.0,lbl2,ann6,2025-01-25T06:20:54.106+00:00,2025-01-25T06:20:54.851+00:00,BOX,0.51
sample_dataset,2025_01_25_06_20_50,0.0,10.0,0.0,72000.0,lbl2,ann4,2025-01-25T06:20:50.000+00:00,2025-01-25T06:21:00.000+00:00,WEAK,0.87
sample_dataset,2025_01_25_06_20_50,4.24434638720353,4.78488692774407,6468.0,16875.0,lbl2,ann4,2025-01-25T06:20:54.244+00:00,2025-01-25T06:20:54.784+00:00,BOX,0.11
sample_dataset,2025_01_25_06_20_50,0.0,10.0,0.0,72000.0,lbl1,ann6,2025-01-25T06:20:50.000+00:00,2025-01-25T06:21:00.000+00:00,WEAK,0.28
sample_dataset,2025_01_25_06_20_50,0.0,10.0,0.0,72000.0,lbl2,ann3,2025-01-25T06:20:50.000+00:00,2025-01-25T06:21:00.000+00:00,WEAK,0.56
sample_dataset,2025_01_25_06_20_50,4.01751241562975,4.9965526803843,5764.0,14729.0,lbl2,ann3,2025-01-25T06:20:54.017+00:00,2025-01-25T06:20:54.996+00:00,BOX,0.98
sample_dataset,2025_01_25_06_20_50,8.40250965776985,9.58149476532639,7875.0,19124.0,lbl2,ann3,2025-01-25T06:20:58.402+00:00,2025-01-25T06:20:59.581+00:00,BOX,0.79
sample_dataset,2025_01_26_06_20_00,0.0,10.0,0.0,72000.0,lbl2,ann2,2025-01-26T06:20:00.000+00:00,2025-01-26T06:20:10.000+00:00,WEAK,0.11
sample_dataset,2025_01_26_06_20_00,3.46662989520132,4.02371759514617,7523.0,15257.0,lbl2,ann2,2025-01-26T06:20:03.466+00:00,2025-01-26T06:20:04.023+00:00,BOX,0.23
sample_dataset,2025_01_26_06_20_00,0.0,10.0,0.0,72000.0,lbl1,ann2,2025-01-26T06:20:00.000+00:00,2025-01-26T06:20:10.000+00:00,WEAK,0.26
sample_dataset,2025_01_26_06_20_00,0.0,10.0,0.0,72000.0,lbl1,ann5,2025-01-26T06:20:00.000+00:00,2025-01-26T06:20:10.000+00:00,WEAK,0.35
sample_dataset,2025_01_26_06_20_00,0.0717043574186431,8.90788747931605,1265.0,10265.0,lbl1,ann5,2025-01-26T06:20:00.071+00:00,2025-01-26T06:20:08.907+00:00,BOX,0.36
sample_dataset,2025_01_26_06_20_00,0.0,10.0,0.0,72000.0,lbl2,ann1,2025-01-26T06:20:00.000+00:00,2025-01-26T06:20:10.000+00:00,WEAK,0.72
sample_dataset,2025_01_26_06_20_00,3.32873690016547,4.0457804743519,7031.0,16453.0,lbl2,ann1,2025-01-26T06:20:03.328+00:00,2025-01-26T06:20:04.045+00:00,BOX,0.31
sample_dataset,2025_01_26_06_20_00,7.03530060672918,7.64754550468836,6468.0,15187.0,lbl2,ann1,2025-01-26T06:20:07.035+00:00,2025-01-26T06:20:07.647+00:00,BOX,0.86
sample_dataset,2025_01_26_06_20_00,0.0,10.0,0.0,72000.0,lbl1,ann1,2025-01-26T06:20:00.000+00:00,2025-01-26T06:20:10.000+00:00,WEAK,0.37
sample_dataset,2025_01_26_06_20_00,0.0,10.0,0.0,72000.0,lbl2,ann4,2025-01-26T06:20:00.000+00:00,2025-01-26T06:20:10.000+00:00,WEAK,0.11
sample_dataset,2025_01_26_06_20_00,3.30667402095974,4.00165471594043,7875.0,19828.0,lbl2,ann4,2025-01-26T06:20:03.306+00:00,2025-01-26T06:20:04.001+00:00,BOX,0.81
sample_dataset,2025_01_26_06_20_00,0.0,10.0,0.0,72000.0,lbl2,ann3,2025-01-26T06:20:00.000+00:00,2025-01-26T06:20:10.000+00:00,WEAK,0.58
"""


STATUS = """dataset,filename,ann1,ann2,ann3,ann4,ann5,ann6
sample_dataset,2025_01_25_06_20_00,FINISHED,FINISHED,FINISHED,FINISHED,FINISHED,FINISHED
sample_dataset,2025_01_25_06_20_10,FINISHED,FINISHED,FINISHED,FINISHED,FINISHED,FINISHED
sample_dataset,2025_01_25_06_20_20,FINISHED,FINISHED,FINISHED,FINISHED,FINISHED,FINISHED
sample_dataset,2025_01_25_06_20_30,FINISHED,FINISHED,FINISHED,FINISHED,FINISHED,FINISHED
sample_dataset,2025_01_25_06_20_40,FINISHED,FINISHED,FINISHED,FINISHED,FINISHED,FINISHED
sample_dataset,2025_01_25_06_20_50,FINISHED,FINISHED,FINISHED,FINISHED,FINISHED,FINISHED
sample_dataset,2025_01_26_06_20_20,FINISHED,FINISHED,FINISHED,FINISHED,FINISHED,FINISHED
"""

# ---------------------------------------------------------------------------
# Fake recording planning CSV used for tests
# ---------------------------------------------------------------------------
RECORDING_PLANNING_CSV = """start_recording,end_recording,start_deployment,end_deployment
2024-01-01 00:00:00+0000,2024-04-09 02:00:00+0000,2024-01-02 00:00:00+0000,2024-04-30 02:00:00+0000
2024-04-30 01:00:00+0000,2024-07-14 06:00:00+0000,2024-04-30 02:00:00+0000,2024-07-06 14:00:00+0000
"""


@pytest.fixture
def sample_df() -> DataFrame:
    df = read_csv(io.StringIO(SAMPLE), parse_dates=["start_datetime", "end_datetime"])
    return df.sort_values(["start_datetime", "end_datetime", "annotator", "annotation"]).reset_index(drop=True)


@pytest.fixture
def sample_status() -> DataFrame:
    return read_csv(io.StringIO(STATUS)).reset_index(drop=True)


@pytest.fixture
def sample_csv_result(tmp_path: Path, sample_df: DataFrame) -> Path:
    result_file = tmp_path / "results.csv"
    df_copy = sample_df.copy()
    df_copy["start_datetime"] = [strftime_osmose_format(ts) for ts in sample_df["start_datetime"]]
    df_copy["end_datetime"] = [strftime_osmose_format(ts) for ts in sample_df["end_datetime"]]
    df_copy.to_csv(result_file, index=False)
    return result_file


@pytest.fixture
def sample_csv_timestamp(tmp_path: Path, sample_status: DataFrame) -> Path:
    ts_file = tmp_path / "status.csv"
    sample_status.to_csv(ts_file, index=False)
    return ts_file


@pytest.fixture
def sample_yaml(
        tmp_path: Path,
        sample_csv_result: Path,
        sample_csv_timestamp: Path,
) -> Path:
    yaml_content = {
        f"{sample_csv_result}": {
            "timebin_new": None,
            "begin": None,
            "end": None,
            "annotator": "ann1",
            "annotation": "lbl1",
            "box": True,
            "timestamp_file": f"{sample_csv_timestamp}",
            "filename_format": "%Y_%m_%d_%H_%M_%S",
            "user_sel": "all",
            "f_min": None,
            "f_max": None,
            "score": None,
        },
    }

    yaml_file = tmp_path / "filters.yaml"
    with yaml_file.open("w", encoding="utf-8") as f:
        yaml.safe_dump(yaml_content, f)

    return yaml_file


@pytest.fixture
def sample_audio(tmp_path: Path) -> Path:
    file_path = tmp_path / "audio.wav"

    duration = 1.0
    samplerate = 1000
    t = np.linspace(0, duration, int(samplerate * duration), endpoint=False)

    freq = 440
    audio = 0.5 * np.sin(2 * np.pi * freq * t)

    rng = np.random.default_rng(seed=42)
    noise = 0.02 * rng.standard_normal(len(t))
    audio = (audio + noise).astype(np.float32)

    sf.write(file_path, audio, samplerate=samplerate)
    return file_path


@pytest.fixture
def tmp_audio_dir(tmp_path: Path) -> Path:

    def create_file(path: Path, size: int = 2048):
        """Create a file of given size in bytes."""
        path.write_bytes(os.urandom(size))

    # size 2KB to bypass `create_raven_file_list` watchdog
    create_file(tmp_path / "file1.wav")
    create_file(tmp_path / "file2.wav")
    nested = tmp_path / "nested"
    nested.mkdir()
    create_file(nested / "file3.wav")
    create_file(nested / "file4.wav")
    (tmp_path / "ignore.txt").write_text("not audio")
    return tmp_path


@pytest.fixture
def recording_planning_csv(tmp_path) -> Path:
    """Create a temporary CSV file simulating a recording planning."""
    path = tmp_path / "recording_planning.csv"
    path.write_text(RECORDING_PLANNING_CSV)
    return path


@pytest.fixture
def recording_planning_config(recording_planning_csv):
    """Minimal config object compatible with RecordingPeriod.from_path."""
    class RecordingPlanningConfig:
        timestamp_file: Path = recording_planning_csv
        timebin_origin = frequencies.to_offset("1min")

    return RecordingPlanningConfig()
